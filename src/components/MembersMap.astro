---
import "maplibre-gl/dist/maplibre-gl.css";
import type { Member } from "./Memberslist.astro";
import centroid from "@turf/centroid";
import { featureCollection } from "@turf/helpers";

interface Props {
  members: Member[];
}

const response = await fetch(
  "https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_0_countries.geojson"
);
const world: Awaited<GeoJSON.FeatureCollection<GeoJSON.MultiPolygon>> =
  await response.json();

const { members } = Astro.props;

const membersPerCountry = members.reduce(
  (acc: Map<string, Member[]>, member) => {
    const country = member.country;
    if (!country) return acc;
    if (!acc.get(country)) {
      acc.set(country, []);
    }
    acc.get(country)!.push(member);
    return acc;
  },
  new Map<string, Member[]>()
);

const centroids = featureCollection(
  world.features.flatMap((d) => {
    const { properties, geometry } = d;
    const countryCode = properties?.iso_a2;
    const countryName = properties?.admin;
    const members = membersPerCountry.get(countryCode);
    if (!countryCode || !members) return [];
    const feature = centroid(geometry, {
      properties: { countryCode, countryName, members },
    });
    return feature;
  })
);
---

<members-map data-members={JSON.stringify(centroids)}>
  <div id="members-map" style="width: 100%; height: 400px;"></div>
</members-map>

<script>
  import maplibregl, { LngLat } from "maplibre-gl";
  import { style } from "../lib/map-style";

  class MembersMap extends HTMLElement {
    connectedCallback() {
      const members = this.dataset.members;

      const map = new maplibregl.Map({
        container: "members-map",
        style: style,
        center: [0, 20],
        zoom: 1.5,
        scrollZoom: false,
        boxZoom: false,
        doubleClickZoom: false,
      });

      map.on("load", () => {
        const membersPerCountry = JSON.parse(members ?? "");

        map.addSource("members", {
          type: "geojson",
          data: membersPerCountry,
          attribution:
            "<a href='https://www.naturalearthdata.com'>Natural Earth Data</a>",
        });
        map.addLayer({
          id: "members-points",
          type: "circle",
          source: "members",
          paint: {
            "circle-radius": [
              "step",
              ["length", ["get", "members"]],
              0,
              1,
              3,
              2,
              5,
              3,
              7,
              4,
              9,
            ],
            "circle-color": "rgb(0, 255, 0)",
            "circle-stroke-color": "white",
            "circle-stroke-width": 1,
          },
        });

        map.on("click", "members-points", (e) => {
          const feature = e.features?.[0];
          const { properties, geometry } = feature!;
          const { members, countryName, countryCode } = properties;
          const membersList = JSON.parse(members)
            .map((m: { name: string }) => `<li>${m.name}</li>`)
            .join("");

          // guard and narrow to Point before accessing coordinates
          if (!geometry || geometry.type !== "Point") return;
          const coords = (geometry as GeoJSON.Point).coordinates;
          const [lng, lat] = coords;
          const center = new LngLat(lng, lat);

          new maplibregl.Popup()
            .setLngLat(center)
            .setHTML(
              `<strong>${countryName} (${countryCode})</strong>
              <ul style="margin: 0; padding-left: 0em; list-style-type: none;">${membersList}</ul>`
            )
            .addTo(map);

          map.flyTo({
            center,
            essential: true,
          });
        });
      });
    }
  }

  customElements.define("members-map", MembersMap);
</script>

<style>
  .maplibregl-map {
    font-family: var(--font-family-body);
  }
</style>
